name: Terraform Pipeline

# trigger: run on push or PR to main branch
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  TF_VERSION: "1.7.0"
  AWS_REGION: "us-east-1"

jobs:
  # job 1: check code formatting and validate Terraform syntax
  validate:
    name: Lint & Validate
    runs-on: ubuntu-latest
    steps:
      # download the repository code into the runner
      - name: Checkout code
        uses: actions/checkout@v4

      # install the specified version of Terraform CLI
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      # fail if any .tf files are not properly formatted
      - name: Terraform Format Check
        run: terraform fmt -check -recursive

      # initialize Terraform without a backend (no AWS credentials needed)
      - name: Terraform Init
        run: terraform init -backend=false

      # check that all Terraform configuration is syntactically valid
      - name: Terraform Validate
        run: terraform validate

  # job 2: scan Terraform code for security misconfigurations
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # run tfsec - static analysis tool that checks for AWS security best practices
      # soft_fail: true means pipeline continues even if issues are found
      - name: Run tfsec
        uses: aquasecurity/tfsec-action@v1.0.0
        with:
          soft_fail: true

  # job 3: generate and save an infrastructure plan (diff)
  plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    needs: security
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      # authenticate to AWS using credentials stored in GitHub Secrets
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init
        run: terraform init

      # generate a plan showing what changes will be made to infrastructure
      - name: Terraform Plan
        run: terraform plan -out=tfplan

      # save the plan file so the deploy job can use it
      - name: Upload Plan
        uses: actions/upload-artifact@v4
        with:
          name: tfplan
          path: tfplan

  # job 4: apply the infrastructure changes (only on push to main, not PRs)
  deploy:
    name: Terraform Apply
    runs-on: ubuntu-latest
    needs: plan
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init
        run: terraform init

      # download the plan file saved by the plan job
      - name: Download Plan
        uses: actions/download-artifact@v4
        with:
          name: tfplan

      # apply the exact plan that was reviewed - no surprises
      - name: Terraform Apply
        run: terraform apply -auto-approve tfplan

  # job 5: run integration tests after deployment (placeholder)
  test:
    name: Test Execution
    runs-on: ubuntu-latest
    needs: deploy
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # install dependencies required by the test script
      - name: Install dependencies
        run: npm install @aws-sdk/client-cognito-identity-provider axios

      # placeholder: in a live environment, Terraform outputs (Cognito pool ID,
      # API URLs) would be captured and injected as environment variables here.
      # AWS credentials are not provided to this runner per assessment requirements.
      - name: Run integration tests (placeholder)
        run: |
          echo "test step placeholder - would execute:"
          echo "  USER_POOL_ID=\${{ secrets.USER_POOL_ID }} \\"
          echo "  CLIENT_ID=\${{ secrets.CLIENT_ID }} \\"
          echo "  API_URL_US=\${{ secrets.API_URL_US }} \\"
          echo "  API_URL_EU=\${{ secrets.API_URL_EU }} \\"
          echo "  TEST_EMAIL=\${{ secrets.TEST_EMAIL }} \\"
          echo "  TEST_PASSWORD=\${{ secrets.TEST_PASSWORD }} \\"
          echo "  node scripts/test.js"
